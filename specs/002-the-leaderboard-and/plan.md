# Implementation Plan: Leaderboard and Feedback System

**Branch**: `002-the-leaderboard-and` | **Date**: 2025-01-13 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/002-the-leaderboard-and/spec.md`

## Summary

Build a community-driven leaderboard and feedback system with:
- **Client-side**: Vanilla JS for score submission, replay playback, voting UI
- **Backend**: Cloudflare Workers for queue/API, GitHub Actions for processing
- **Storage**: Cloudflare KV for queue, static JSON files for leaderboard/feedback
- **Anti-cheat**: Hash-based session validation, public replays, community voting

**Technical Approach**: Hybrid static/serverless architecture where the game (client) posts data to Cloudflare Workers (queue), GitHub Actions periodically processes the queue to generate static JSON files deployed via GitHub Pages, and the client reads these static files to display leaderboard/feedback.

## Technical Context

**Language/Version**: JavaScript (ES6+), HTML5, CSS3 (vanilla only per constitution)
**Primary Dependencies**: ZERO (per constitution) - Web Crypto API, localStorage, fetch API only
**Storage**: Cloudflare KV (queue), static JSON files (GitHub Pages), localStorage (cookies)
**Testing**: Manual browser testing (no test framework per constitution)
**Target Platform**: Desktop browsers (Chrome, Firefox, Safari current versions)
**Project Type**: Web (static frontend + serverless backend + GitHub Actions worker)
**Performance Goals**: <2s score submission, <1s leaderboard load, 1000 concurrent views
**Constraints**: Client-side only for game, no build tools, no frameworks, no npm dependencies
**Scale/Scope**: Top 10-20 scores displayed, 30-50 stored, unlimited queue items processed periodically

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

### ⚠️ VIOLATION: Principle IV - Client-Side Only

**Violation Details**: This feature requires Cloudflare Workers (serverless backend) and GitHub Actions (server-side worker) to handle score submission, storage, and processing.

**Justification**:
1. **No viable alternative**: Public leaderboards require persistent storage beyond localStorage. Static JSON files need generation from submitted scores.
2. **Minimal server use**: Cloudflare Workers only queue data (lightweight). GitHub Actions only process queue periodically (not real-time server).
3. **Maintains spirit**: Game itself remains 100% client-side. Network calls only for leaderboard features, game playable offline.
4. **Open source**: Both Cloudflare Workers code and GitHub Actions workflows will be in repository.

### ✅ PASSES: Principle I - Zero Dependencies

- Cloudflare Workers: No npm dependencies, pure JS
- GitHub Actions: Uses bash/python scripts, no external libraries
- Client-side: Pure vanilla JS, Web APIs only

### ✅ PASSES: Principle II - Fun First

- Leaderboards add competitive element (enhances fun)
- Replays let players learn from others (educational + fun)
- Voting/flagging protects legitimate players (maintains fair fun)

### ✅ PASSES: Principle III - Progressive Mastery

- Leaderboard doesn't interfere with typing progression
- Optional feature - players can ignore and focus on learning

### ✅ PASSES: Principle V - Desktop-First

- Voting requires careful clicking (desktop interaction)
- Replay viewing best on larger screens
- No mobile compromises

## Project Structure

### Documentation (this feature)

```
specs/002-the-leaderboard-and/
├── plan.md              # This file
├── research.md          # Phase 0 output (Cloudflare/GH Actions patterns)
├── data-model.md        # Phase 1 output (entities, schemas)
├── quickstart.md        # Phase 1 output (setup instructions)
├── contracts/           # Phase 1 output (API contracts)
│   ├── cloudflare-worker-api.md
│   └── leaderboard-data-schema.md
└── tasks.md             # Phase 2 output (NOT created yet)
```

### Source Code (repository root)

```
# Client-side (vanilla JS)
js/
├── leaderboard.js       # Leaderboard UI and data loading
├── replay.js            # Replay playback engine
├── voting.js            # Voting/flagging UI
├── feedback.js          # Feedback submission UI
└── user-identity.js     # UID cookie management

# GitHub Actions worker
.github/workflows/
└── process-leaderboard-queue.yml  # Periodic queue processor

# Cloudflare Workers (repo root)
workers/
└── leaderboard-api.js    # Handles score, replay, feedback, and voting endpoints

# Static data (generated by GH Actions, served by GH Pages)
data/
├── leaderboard.json     # Top scores with replay links
├── feedback.json        # Feedback items with votes
└── replays/
    └── [session-hash].json  # Individual replay data

# Python scripts (for GH Actions)
scripts/
├── process_queue.py     # Main queue processor
├── validate_session.py  # Hash validation logic
└── generate_static.py   # JSON file generation
```

**Structure Decision**: Hybrid architecture with three components:
1. **Client-side vanilla JS** for all UI interactions (constitution-compliant)
2. **Cloudflare Workers** for lightweight API/queue (serverless, open source)
3. **GitHub Actions + Python scripts** for periodic processing (automated, transparent)

This maintains the spirit of "client-side only" for the core game while adding minimal server infrastructure only for community features.

## Complexity Tracking

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| Cloudflare Workers backend | Need persistent storage beyond localStorage for public leaderboard visible to all users | localStorage only works per-browser, can't share scores across users |
| GitHub Actions processing | Need to aggregate scores, generate static files, validate submissions periodically | Client-side generation would allow trivial cheating and require all clients to download full queue |
| Python scripts in GH Actions | Need hash validation, data processing, file generation | Pure bash too limited for JSON manipulation and validation logic |
